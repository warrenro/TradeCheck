# TradeCheck 交易審計系統
- **版本**: v1.6
- **最後更新日期**: 2025-12-06

本專案是一個專為短線交易者設計的交易紀錄分析與風險控管工具。它能讀取您的交易歷史（支援 `.csv` 或 `.xlsx` 格式），並根據 **D-Pro** 風控規則進行審計與 **交易 DNA 診斷**，最終生成一份綜合 JSON 報告，幫助您評估交易表現並識別潛在風險。

此專案包含兩種操作模式：
1.  **指令碼模式 (Command-Line)**: 直接執行 Python 腳本，生成一份 `audit_report.json` 檔案。
2.  **網頁介面模式 (Web UI)**: 透過內建的 Python 伺服器與前端介面進行互動操作。

---

## 近期更新 (Recent Updates)

為了提供更精準的交易分析與風險評估，系統近期已整合以下新功能：

- **帳戶權益數動態計算**: 帳戶的「目前權益數」現在會基於 `config.ini` 中的 `monthly_start_capital` 加上當月的損益 (Monthly PnL) 動態計算。這取代了原先直接從 `config.ini` 讀取 `current_capital` 的方式，使評估更為即時和準確。

- **交易 DNA 診斷 (Trading DNA Diagnosis)**:
  - 將您的每筆交易依「獲利/虧損點數」自動歸類至 **噪音區** 或 **波段區**，幫助您識別主要的獲利來源與無效的交易行為。

- **SOP 風險壓力測試 (SOP Risk Stress Test)**:
  - 模擬在當前操作規模下的潛在最大月度風險，並計算 **風險率**，提早對可能超出負荷的風險提出警告。

- **夜盤避險時段規則 (Night Session Rule)**:
  - 新增對 `21:15-21:45` 及 `01:45-02:15` 兩個夜盤敏感時段的交易監控。

- **季度成本模擬 (Quarterly Cost Simulation)**:
  - 在 **3, 6, 9, 12 月** 的升級評估中，自動扣除一筆固定成本，使資本評估更貼近真實的營運狀況。

這些功能皆已整合至核心審計邏輯中，並會體現在 `audit_report.json` 報告與網頁介面上。

---

## 核心功能 (Core Features)

- **交易 DNA 診斷 (Trading DNA Diagnosis)**:
  - 將每筆交易依「獲利/虧損點數」分為 **噪音區 (<=40點)** 與 **波段區 (>40點)**。
  - 診斷是否陷入「**陷入泥淖**」的無效交易模式，並評估主要獲利來源的健康度。

- **D-Pro 風險審計 (D-Pro Risk Audit)**:
  - **日內風控**: 每日虧損筆數不得超過 **3** 筆。
  - **月度資金熔斷**: 當月總虧損不得超過 `月初本金 * 15%`。
  - **月度策略熔斷**: 單月觸發「日內風控」的次數不得超過 **10** 次。
  - **夜盤避險時段**: 禁止在 `21:15-21:45` 及 `01:45-02:15` 兩個時段內有交易活動。

- **SOP 風險壓力測試 (SOP Risk Stress Test)**:
  - 根據固定的 `1500` 點最大曝險，計算當前操作規模下的 **風險率**。
  - 當 `風險率 > 15%` 時，系統會發出「**高風險警告**」。

- **帳戶升級評估 (Account Upgrade Assessment)**:
  - **每月評估**: 根據資本額、風報比與勝率，判斷是否符合晉升下一級的資格。
  - **季度成本模擬**: 在 **3, 6, 9, 12 月**進行評估時，會從淨值中扣除 **25,000** 元的模擬固定成本，讓評估更貼近真實營運狀況。

- **日誌記錄 (Logging)**:
  - 將所有操作與錯誤統一記錄至 `trade_audit.log`，方便追蹤與除錯。

---

## 技術棧 (Tech Stack)

- **後端 (Backend)**: Python, Pandas, FastAPI
- **前端 (Frontend)**: HTML, JavaScript (vanilla)
- **核心邏輯 (Core Logic)**: Python

---

## 安裝與啟動 (Installation & Usage)

### 1. 安裝 Python 依賴套件
```bash
pip install --upgrade -r requirements.txt
```

### 2. 建立設定檔
在專案根目錄下，建立一個名為 `config.ini` 的檔案，並填入以下內容。請根據您的實際情況修改數值。

```ini
[Account]
# 審計月份的月初本金。目前的帳戶權益數將由此本金加上當月損益動態計算。
monthly_start_capital = 1000000

# 您目前的操作規模 (合約口數)
operation_contracts = 10
```

### 3. 準備交易資料
-   將您的交易紀錄檔案（支援 `.csv` 或 `.xlsx` 格式）放入專案根目錄下的 `tradedata/` 資料夾中。
-   腳本會自動讀取此資料夾內最新的檔案。

---

## 執行模式

### 模式一：指令碼 (Command-Line)
1.  **執行 Python 指令碼:**
    ```bash
    python trade_check.py
    ```
2.  **查看結果**:
    -   執行完畢後，會在專案根目錄生成一份 `audit_report.json` 檔案，其中包含所有詳細的審計結果。

### 模式二：網頁介面 (Web UI)
1.  **啟動後端伺服器:**
    ```bash
    python server.py
    ```
    後端服務將會運行在 `http://localhost:8000`，並同樣讀取 `config.ini` 的設定。

2.  **開啟瀏覽器**並訪問 `http://localhost:8000`，即可開始使用。

---

## 資料格式要求

為了讓系統能順利執行，交易紀錄檔案必須包含以下 **五個欄位**:

1.  **成交時間**: 交易發生的完整時間，格式需為 `YYYY/MM/DD HH:MM:SS`。
2.  **買賣別**: 交易的類型。
3.  **平倉損益淨額**: 該筆交易的淨損益，需為數值。
4.  **口數**: 交易的合約數量，需為數值。
5.  **商品名稱**: 用於判斷合約點值 (e.g., `小型期`, `微型台指期`)。

---

## 檔案結構 (Project Structure)

```
TradeCheck/
├── frontend/                # 前端應用程式 (HTML, JS)
├── tradedata/               # 存放交易紀錄檔案的資料夾
├── config.ini               # 使用者參數設定檔
├── trade_check.py           # 核心審計邏輯 (指令碼模式)
├── server.py                # 後端伺服器 (網頁模式)
├── requirements.txt         # Python 依賴套件
├── audit_report.json        # 審計報告輸出檔
├── spec.md                  # 系統規格書
└── README.md                # 本說明文件
```
---

## 附錄：帳戶升級資格計算方法

本系統會根據 `trade_check.py` 中定義的規則，評估帳戶是否符合升級資格。

### 1. 升級標準 (Upgrade Criteria)
| 目前級別 | 目標級別 | 資本額要求 (Capital) | 風報比要求 (RR) | 勝率要求 (WR) |
|:--------:|:--------:|:----------------------:|:-----------------:|:-----------------:|
|    S1    |    S2    |      `>= 200,000`      |      `>= 1.5`     |      `>= 25%`     |
|    S2    |    S3    |      `>= 400,000`      |      `>= 2.0`     |      `>= 30%`     |
|    S3    |    S4    |      `>= 600,000`      |      `>= 2.0`     |      `>= 33%`     |
|    S4    |    S5    |      `>= 800,000`      |      `>= 2.5`     |      `>= 35%`     |

### 2. 資格綜合評估
帳戶必須 **同時滿足** 以下兩個條件，才能獲得升級資格：
1.  **資本額達標**: `調整後資本額 >= 該級別的資本額要求`
2.  **交易表現達標**: `風報比 >= 要求` 且 `勝率 >= 要求`

### 3. 新增：特殊計算規則 - 固定成本扣除
- **目的**: 模擬真實世界的固定營運成本。
- **觸發時機**: 當升級審查的月份為 **3月、6月、9月、或12月** 時。
- **計算方式**: `調整後資本額 = 目前權益數 - 25,000`。
- **應用**: 此`調整後資本額`專門用於升級資格的「資本額達標」判斷。報告中會明確標示此扣除項。
# TradeCheck 交易審計系統
- **版本**: v2.3
- **最後更新日期**: 2025-12-09

本專案是一個專為短線交易者設計的交易紀錄分析與風險控管工具。它能讀取您的交易歷史（支援 `.csv` 或 `.xlsx` 格式），並根據 **D-Pro** 風控規則進行審計與 **交易 DNA 診斷**，最終生成一份綜合 JSON 報告，幫助您評估交易表現並識別潛在風險。

此專案包含兩種操作模式：
1.  **指令碼模式 (Command-Line)**: 直接執行 Python 腳本，生成一份 `audit_report.json` 檔案。
2.  **網頁介面模式 (Web UI)**: 透過內建的 Python 伺服器與前端介面進行互動操作。

---

## 近期更新 (Recent Updates)

為了提供更精準的交易分析與風險評估，系統近期已整合以下新功能：

- **K線圖顯示功能 (Candlestick Chart Display)**: 在網頁介面新增了「行情圖表」分頁，可將匯入的 K 線資料以互動式圖表呈現。
- **K線資料匯入**: 可從 `KData/` 目錄下選擇指定的 K 線歷史行情檔案匯入資料庫，為將來的策略回測與價量分析奠定基礎。
- **交易資料圖層**: 在 K 線圖上可以疊加顯示您的買入/賣出交易點，以直觀的箭頭標示，方便回顧交易決策。
- **負值紅色突顯**: 在網頁介面上，所有負數的財務指標（如單筆或總和損益）均以紅色字體顯示，讓虧損狀況一目了然。
- **前端年度總結區塊**: 在網頁介面中「月度總結」下方新增「年度總結」區塊，此區塊現在會針對每個交易年份獨立計算並顯示其總體交易表現，包括總損益、整體勝率、賺賠比和總交易筆數。
- **前端顯示月初本金**: 在網頁介面的「帳戶狀態」區塊，新增顯示 `config.ini` 中設定的 `monthly_start_capital` (月初本金)，提供更完整的帳戶起始資訊。
- **帳戶權益數動態計算**: 帳戶的「目前權益數」現在會基於 `config.ini` 中的 `monthly_start_capital` 加上當月的損益 (Monthly PnL) 動態計算。這取代了原先直接從 `config.ini` 讀取 `current_capital` 的方式，使評估更為即時和準確。
- **交易 DNA 診斷 (Trading DNA Diagnosis)**:
  - 將您的每筆交易依「獲利/虧損點數」自動歸類至 **噪音區** 或 **波段區**，幫助您識別主要的獲利來源與無效的交易行為。
- **SOP 風險壓力測試 (SOP Risk Stress Test)**:
  - 模擬在當前操作規模下的潛在最大月度風險，並計算 **風險率**，提早對可能超出負荷的風險提出警告。
- **夜盤避險時段規則 (Night Session Rule)**:
  - 新增對 `21:15-21:45` 及 `01:45-02:15` 兩個夜盤敏感時段的交易監控。
- **季度成本模擬 (Quarterly Cost Simulation)**:
  - 在 **3, 6, 9, 12 月** 的升級評估中，自動扣除一筆固定成本，使資本評估更貼近真實的營運狀況。

這些功能皆已整合至核心審計邏輯中，並會體現在 `audit_report.json` 報告與網頁介面上。

---

## 核心功能 (Core Features)

- **K線圖顯示功能 (Candlestick Chart Display)**: 
  - 在網頁介面提供一個互動式的圖表介面，包含標準的 K 線圖以及成交量柱狀圖。
  - **新增功能工具列**，提供以下進階分析功能：
    - **時間週期切換**: 可在 1分, 5分, 15分, 1小時, 日線 等不同時間週期之間切換。
    - **交易資料圖層**: 允許使用者將自己的買入/賣出交易紀錄疊加顯示在 K 線圖上，以直觀的向上/向下箭頭標示，並在滑鼠懸停時顯示交易詳情。
    - **技術指標圖層**: 允許使用者在圖表上疊加移動平均線 (MA)、成交量 (Volume)、相對強弱指標 (RSI) 等多種技術指標，並可獨立控制其顯示與設定。
    - **圖表類型**: 可切換 K線圖 或 線圖 模式。
    - **匯出圖表**: 可將當前圖表畫面下載為 PNG 圖片。
- **K線資料匯入功能 (K-Line Data Import)**:
  - 可將 `KData/` 資料夾內的 K 線行情資料 (CSV 格式) 匯入至後端 SQLite 資料庫。
  - 此功能將市場行情與交易紀錄整合，為未來進行更複雜的策略回測與分析（例如：分析交易發生時的市場價量狀態）提供資料基礎。
- **資料庫化與匯入功能 (Databasing and Import)**:
  - 提供「匯入」功能，可將分散的 CSV 交易紀錄整合至單一 SQLite 資料庫 (`trade_notes.db`) 中。
  - 核心分析流程改為從資料庫讀取，為未來進行複雜的跨檔案歷史分析奠定基礎。
- **交易備註功能 (Trade Annotation)**:
  - 為每一筆交易新增、編輯和儲存個人備註。
  - 備註會獨立儲存在本地資料庫 (`trade_notes.db`) 中，不影響原始交易資料。
- **交易 DNA 診斷 (Trading DNA Diagnosis)**:
  - 將每筆交易依「獲利/虧損點數」分為 **噪音區 (<=40點)** 與 **波段區 (>40點)**。
  - 診斷是否陷入「**陷入泥淖**」的無效交易模式，並評估主要獲利來源的健康度。
- **D-Pro 風險審計 (D-Pro Risk Audit)**:
  - **日內風控**: 每日虧損筆數不得超過 **3** 筆。
  - **月度資金熔斷**: 當月總虧損不得超過 `月初本金 * 15%`。
  - **月度策略熔斷**: 單月觸發「日內風控」的次數不得超過 **10** 次。
  - **夜盤避險時段**: 禁止在 `21:15-21:45` 及 `01:45-02:15` 兩個時段內有交易活動。
- **SOP 風險壓力測試 (SOP Risk Stress Test)**:
  - 根據固定的 `1500` 點最大曝險，計算當前操作規模下的 **風險率**。
  - 當 `風險率 > 15%` 時，系統會發出「**高風險警告**」。
- **帳戶升級評估 (Account Upgrade Assessment)**:
  - **每月評估**: 根據資本額、風報比與勝率，判斷是否符合晉升下一級的資格。
  - **季度成本模擬**: 在 **3, 6, 9, 12 月**進行評估時，會從淨值中扣除 **25,000** 元的模擬固定成本，讓評估更貼近真實營運狀況。
- **日誌記錄 (Logging)**:
  - 系統會每日生成獨立的日誌檔案，格式為 `trade_audit_YYYY-MM-DD.log`。
  - 應用程式啟動時，會自動將所有過去的日誌檔案（含舊格式的 `trade_audit.log`）歸檔至 `LOG/` 資料夾中，保持根目錄的整潔。

---

## 技術棧 (Tech Stack)

- **後端 (Backend)**: Python, Pandas, FastAPI, SQLite
- **前端 (Frontend)**: Vue.js, Vue-i18n, lightweight-charts
- **核心邏輯 (Core Logic)**: Python

---

## 安裝與啟動 (Installation & Usage)

### 1. 後端 (Backend)
#### a. 安裝 Python 依賴套件
```bash
pip install --upgrade -r requirements.txt
```

#### b. 建立設定檔
在專案根目錄下，建立一個名為 `config.ini` 的檔案，並填入以下內容。請根據您的實際情況修改數值。

```ini
[Account]
# 審計月份的月初本金。目前的帳戶權益數將由此本金加上當月損益動態計算。
monthly_start_capital = 1000000

# 您目前的操作規模 (合約口數)
operation_contracts = 10

# 您目前的帳戶級別 (e.g., S1, S2)
current_scale = S1
```

#### c. 準備資料
-   **交易資料**: 將您的交易紀錄檔案（支援 `.csv` 或 `.xlsx` 格式）放入專案根目錄下的 `tradedata/` 資料夾中。
-   **K線行情資料**: 將您的 K 線歷史行情資料 (CSV 格式) 放入專案根目錄下的 `KData/` 資料夾中。


### 2. 前端 (Frontend)
#### a. 進入前端目錄
```bash
cd frontend
```

#### b. 安裝 Node.js 依賴套件
```bash
npm install
```

#### c. 啟動前端開發伺服器
```bash
npm run dev
```
前端服務將會運行在 `http://localhost:5173`。

---

## 執行模式

### 模式一：指令碼 (Command-Line)
1.  **執行 Python 指令碼:**
    ```bash
    python trade_check.py
    ```
2.  **查看結果**:
    -   執行完畢後，會在專案根目錄生成一份 `audit_report.json` 檔案，其中包含所有詳細的審計結果。

### 模式二：網頁介面 (Web UI)
1.  **啟動後端伺服器:**
    ```bash
    python server.py
    ```
    後端服務將會運行在 `http://localhost:8000`。

2.  **啟動前端開發伺服器:**
    (在另一個終端機視窗中)
    ```bash
    cd frontend
    npm run dev
    ```

3.  **開啟瀏覽器**並訪問 `http://localhost:5173`。

4.  **使用介面進行分析**:
    - **匯入交易資料**: 在左側區塊選擇您的交易紀錄檔案後，可點擊「匯入此檔案」按鈕，將該檔案的交易紀錄存入後端資料庫。系統會自動忽略重複的紀錄。
    - **匯入K棒資料**: 點擊「匯入K棒資料」按鈕，系統會彈出一個選擇視窗，列出所有在 `KData/` 目錄下的 CSV 檔案。選擇您想匯入的檔案並確認後，系統會將其匯入資料庫。
    - **執行分析**: 點擊「開始分析」按鈕，系統會從資料庫中讀取已匯入的交易紀錄並執行審計分析。
    - **檢視圖表**: 點擊「行情圖表」分頁，即可看到 K 線圖。
    - **互動式備註**: 在月度總結報告中，點擊月份可查看詳細交易。在詳細交易彈窗中，點擊「編輯」即可為每一筆交易新增或修改備註。

---

## 資料格式要求

### a. 交易紀錄檔案
為了讓系統能順利執行，交易紀錄檔案必須包含以下 **五個欄位**:

1.  **成交時間**: 交易發生的完整時間，格式需為 `YYYY/MM/DD HH:MM:SS`。
2.  **買賣別**: 交易的類型。
3.  **平倉損益淨額**: 該筆交易的淨損益，需為數值。
4.  **口數**: 交易的合約數量，需為數值。
5.  **商品名稱**: 用於判斷合約點值 (e.g., `小型期`, `微型台指期`)。

### b. K線行情資料檔案
K 線行情資料 (CSV) 必須包含以下標準欄位：

1.  `Datetime` 或 `時間`: `YYYY-MM-DD HH:MM:SS` 格式
2.  `Open` 或 `開盤價`
3.  `High` 或 `最高價`
4.  `Low` 或 `最低價`
5.  `Close` 或 `收盤價`
6.  `Volume` 或 `成交量`

---

## 檔案結構 (Project Structure)

```
TradeCheck/
├── KData/                   # 存放 K 線歷史行情資料
├── frontend/                # 前端 Vue.js 應用程式
│   ├── src/
│   │   ├── components/
│   │   ├── App.vue
│   │   └── KlineChart.vue
│   ├── index.html
│   ├── package.json
│   └── vite.config.js
├── tradedata/               # 存放交易紀錄檔案的資料夾
├── config.ini               # 使用者參數設定檔
├── trade_notes.db           # 交易備註與行情資料庫
├── trade_check.py           # 核心審計邏輯 (指令碼模式)
├── import_kdata.py          # 匯入 K 線資料的獨立腳本
├── server.py                # 後端伺服器 (網頁模式)
├── requirements.txt         # Python 依賴套件
├── audit_report.json        # 審計報告輸出檔
├── spec.md                  # 系統規格書
└── README.md                # 本說明文件
```
---

## 附錄：帳戶升級資格計算方法

本系統會根據 `trade_check.py` 中定義的規則，評估帳戶是否符合升級資格。

### 1. 升級標準 (Upgrade Criteria)
| 目前級別 | 目標級別 | 資本額要求 (Capital) | 風報比要求 (RR) | 勝率要求 (WR) |
|:--------:|:--------:|:----------------------:|:-----------------:|:-----------------:|
|    S1    |    S2    |      `>= 200,000`      |      `>= 1.5`     |      `>= 25%`     |
|    S2    |    S3    |      `>= 400,000`      |      `>= 2.0`     |      `>= 30%`     |
|    S3    |    S4    |      `>= 600,000`      |      `>= 2.0`     |      `>= 33%`     |
|    S4    |    S5    |      `>= 800,000`      |      `>= 2.5`     |      `>= 35%`     |

### 2. 資格綜合評估
帳戶必須 **同時滿足** 以下兩個條件，才能獲得升級資格：
1.  **資本額達標**: `調整後資本額 >= 該級別的資本額要求`
2.  **交易表現達標**: `風報比 >= 要求` 且 `勝率 >= 要求`

### 3. 新增：特殊計算規則 - 固定成本扣除
- **目的**: 模擬真實世界的固定營運成本。
- **觸發時機**: 當升級審查的月份為 **3月、6月、9月、或12月** 時。
- **計算方式**: `調整後資本額 = 目前權益數 - 25,000`。
- **應用**: 此`調整後資本額`專門用於升級資格的「資本額達標」判斷。報告中會明確標示此扣除項。

---

## 常見問題 (Frequently Asked Questions)

### Q: K線圖顯示「資料庫中找不到K線資料...」怎麼辦？
**A:** 這個訊息表示 K 線圖的 CSV 原始檔案尚未被匯入到應用程式的資料庫中。請依照以下步驟操作：
1.  確認您的 K 線圖 `.csv` 檔案已經放置在專案的 `KData/` 目錄下。
2.  在網頁介面左側的操作區塊，從「**選擇 K 線行情檔案**」下拉選單中，選擇您要匯入的檔案。
3.  點擊其下方的「**匯入 K 線資料**」按鈕。
4.  待上方跳出成功訊息後，切換回「**行情圖表**」分頁，圖表即可正常顯示。
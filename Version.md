# 版本歷史 (Version History)

## Version 2.5 (2025-12-10)

### ✨ 新功能 (Features)
- **交易資料表格顯示優化**:
  - 在 K 線圖下方的交易資料表格中，明確顯示「成交時間」、「口數」、「新倉價」、「平倉價」、「平倉損益淨額」。
  - 「平倉損益淨額」欄位根據數值的正負，分別以 **藍色** (正值) 和 **紅色** (負值) 顯示，使損益結果更加直觀。

### 🐞 錯誤修正 (Bug Fixes)
- **修復交易圖層顯示錯誤**: 解決了在啟用「交易資料」圖層時，因後端資料缺失 `action` 欄位而導致前端 JavaScript 報錯 (`TypeError: Cannot read properties of undefined (reading 'toLowerCase')`)，進而使交易標記（買賣箭頭）無法顯示的問題。已在前端加入防禦性程式碼，確保圖層在資料不完整時也能正常渲染。
- **修復 K 線圖 Y 軸縮放異常**: 解決了在啟用技術指標（如 MA、BBands）後，Y 軸會被異常拉伸，導致 K 線圖被壓縮成一條線的問題。透過實作自訂的 `autoscaleInfoProvider`，強制圖表在自動縮放時將所有可見的指標線納入計算範圍，確保了圖表主體與指標的顯示比例始終正常。

### 📚 文件 (Documentation)
- 更新 `spec.md` 以反映交易資料表格的顯示規格。
- 更新 `process.md` 記錄 Y 軸縮放及交易圖層的錯誤修復過程。
- 更新 `Version.md` 以包含 v2.5 的所有變更。

## Version 2.4 (2025-12-09)

### 🐞 錯誤修正 (Bug Fixes)
- **修復伺服器啟動錯誤**: 解決了因 `init_database` 函式遺失而導致的 `NameError`，此問題會造成伺服器啟動失敗。透過重構與修正，確保了資料庫初始化函式總是被正確定義與呼叫。
- **修復 K 線圖時間週期切換功能**:
  1. **修正後端資料處理**: 重新編寫了後端在處理不同時間週期 (`resample`) 時的資料清洗邏輯，解決了因過度捨棄數據 (`dropna`) 而導致前端在選擇 `5T`, `1H` 等週期時無資料可顯示的問題。
  2. **修正前端圖表更新邏輯**: 修復了 `KlineChart.vue` 元件中一個關鍵的渲染錯誤。該錯誤導致在切換時間週期後，圖表物件被不正確地銷毀和重建，使新資料無法被繪製。
  
### 📚 文件 (Documentation)
- **全面同步與翻譯文件**: 根據最新的程式碼狀態，全面審閱、更新並翻譯了 `README.md`, `spec.md`, `process.md` 等核心文件，確保文件內容的準確性、完整性，並統一為繁體中文。

## Version 2.1 (2025-12-08)

### ✨ 新功能 (Features)
- **K線資料匯入流程優化**:
  - **使用者自選檔案**: 將原有的「自動掃描匯入」改為「使用者手動選擇」。前端現在會彈出一個檔案選擇器，列出 `KData/` 目錄下的所有 CSV 檔案，讓使用者可以精確選擇要匯入的行情資料。
  - **新增後端 API**: 建立了 `GET /api/kdata_files` 端點來提供檔案列表，並修改了 `POST /api/import_kdata` 來接收指定檔名。
- **前端使用者體驗優化**:
  - **負值紅色突顯**: 在網頁介面上，所有負數的財務指標（如單筆或總和損益）均以紅色字體顯示，讓虧損狀況一目了然。

### ♻️ 重構 (Refactoring)
- **後端腳本模組化**: `import_kdata.py` 腳本被重構為接收檔案路徑參數，使其功能更單一化，易於被 API 調用。

### 📚 文件 (Documentation)
- **全面更新技術與使用者文件**:
  - `spec.md`: 更新了 K 線匯入功能的規格，以及新增了負值突顯的前端呈現說明。
  - `README.md`: 更新了網頁介面的操作說明，以符合新的 K 線匯入流程，並在近期更新中加入了新功能說明。
  - `process.md`: 詳細記錄了新的 K 線匯入功能的架構設計與前後端互動流程。
  - `Version.md`: 更新版本歷史，準確反映 `v2.1` 的所有變更。

## Version 1.9 (2025-12-06)

### ✨ 新功能 (Features)
- **年度總結分年計算**: 「年度總結」區塊現在會針對每個交易年份獨立計算並顯示其總體交易表現（總損益、整體勝率、賺賠比和總交易筆數），取代了之前單一總結所有年份數據的方式，提供更細緻的年度分析視角。

## Version 1.8 (2025-12-06)

### ✨ 新功能 (Features)
- **前端年度總結區塊**: 在網頁介面中「月度總結」下方新增「年度總結」區塊，顯示審計期間的總體交易表現，包括總損益、整體勝率、賺賠比和總交易筆數。

## Version 1.7 (2025-12-06)

### ✨ 新功能 (Features)
- **前端顯示月初本金**: 在網頁介面的「帳戶狀態」區塊，新增顯示 `config.ini` 中設定的 `monthly_start_capital` (月初本金)，提供更完整的帳戶起始資訊。

## Version 1.6 (2025-12-06)

### ✨ 新功能 (Features)
- **帳戶權益數動態計算**: 帳戶的「目前權益數」現在會基於 `config.ini` 中的 `monthly_start_capital` 加上當月的損益 (Monthly PnL) 動態計算。這取代了原先直接從 `config.ini` 讀取 `current_capital` 的方式，使評估更為即時和準確。

## Version 1.5 (2025-12-06)

### ✨ 新功能 (Features)
- **升級資格原因細節**: 在評估與激勵區塊，當帳戶不符合升級資格時，系統現在會列出詳細的計算細節，例如「權益數未達標 (Capital not met): 1,000,000 / 200,000」，讓使用者能清楚了解未達標的具體項目。

## Version 1.4 (2025-12-06)

### 🐞 錯誤修正 (Bug Fixes)
- **修復後端序列化問題**: 解決了當 Pandas/Numpy 的數值型別 (如 `int64`) 無法被標準 `json` 函式庫序列化，導致後端在產生 `audit_report.json` 或 API 回應時崩潰的問題。已加入一個客製化的 JSON 編碼器來正確處理這些數值型別。

## Version 1.3 (2025-12-04)

### ✨ 新功能 (Features)
- **後端狀態顯示**: 前端介面新增後端伺服器狀態指示燈，即時顯示連線狀態。
- **互動式月報表**: 使用者現在可以點擊月統計報表中的任一月份，以彈出式視窗查看該月份的詳細交易明細。

---

## Version 1.2 (2025-12-04)

### ✨ 新功能 (Features)
- **新增 Log 紀錄功能**: 系統現在會將詳細的執行紀錄與錯誤資訊輸出至 `trade_audit.log` 檔案與主控台，方便追蹤與除錯。
- **前端日誌紀錄**: 前端應用程式現在會將關鍵操作事件與錯誤回傳至後端，並統一記錄在 `trade_audit.log` 中。

---

## Version 1.1 (2025-12-04)

### ✨ 新功能 (Features)
- **動態讀取交易資料**: 指令碼 (`trade_check.py`) 現在會自動從 `tradedata/` 資料夾中尋找並分析最新的交易紀錄檔案，無需手動修改程式碼。
- **支援新資料格式**:
    - 能夠自動對應中文欄位名稱 (`成交時間`, `買賣別`, `平倉損益淨額`)。
    - 支援處理帶有千分位逗號的損益金額。

### ♻️ 重構 (Refactoring)
- **移除範例資料**: 刪除了原有的 `dummy_trades.csv`，改為完全依賴 `tradedata/` 中的實際資料。
- **簡化資料處理**: 根據使用者確認，移除了原先用來過濾平倉交易的邏輯，現在所有讀入的資料都會被視為已完成的交易進行分析。

### 📚 文件 (Documentation)
- **更新 `README.md`**:
    - 更新了「指令碼模式」的使用說明，以反映新的檔案讀取機制。
    - 在「檔案結構」中新增了 `tradedata/` 資料夾的說明。
- **更新 `spec.md`**: 新增了「資料格式要求」章節，明確定義了交易紀錄檔案所需的欄位與格式。
- **新增 `Version.md`**: 加入此版本歷史檔案，以記錄未來的開發歷程。
---

## 交易資料顯示優化 (Trade Data Display Enhancement)

為了在K線圖上提供更豐富的交易資訊，將對交易圖層進行功能優化。

### 1. 後端 (server.py)

- **目標**:
  - 確認後端 API (`/api/trade_data`) 回傳的交易資料包含所有必要的欄位。
- **實作**:
  - 交易資料匯入流程 (`/api/import_trades`) 將進行修改，以處理包含 `新倉價 (open_price)` 和 `平倉價 (close_price)` 的CSV檔案。這些欄位將與 `成交時間 (trade_time)`, `口數 (contracts)`, 和 `平倉損益淨額 (net_pnl)` 一同存入 `trades` 資料庫。
  - `GET /api/trade_data` 函式將被修改，其 SQL 查詢及回傳的 JSON 物件會確保包含 `trade_time`, `contracts`, `open_price`, `close_price`, 以及 `net_pnl`。

### 2. 前端 (KlineChart.vue)

- **目標**:
  - 在 K 線圖上繪製交易標記，並在用戶滑鼠懸停時顯示包含詳細資訊的提示框 (Tooltip)。
- **實作**:
  - **修改 `drawTradeData` 函式**:
    - 將修改此函式，為每個交易標記附加一個自定義的提示框。
  - **設計提示框內容**:
    - 提示框將顯示一個列表或表格，包含：`成交時間`, `口數`, `新倉價`, `平倉價`, `平倉損益淨額`。
  - **實現條件性顏色**:
    - 在提示框的 `平倉損益淨額` 欄位上，將使用 Vue.js 的綁定語法來動態設定 CSS class。
    - 如果 `平倉損益淨額 > 0`，文字顏色設為藍色。
    - 如果 `平倉損益淨額 < 0`，文字顏色設為紅色。
  - **更新圖表**:
    - 確保在獲取新數據或切換可見性時，圖表能正確地重繪或清除這些交易標記及其提示框。

### 3. 測試與驗收

- **目標**:
  - 確保新功能如預期般運作。
- **步驟**:
  1. 啟動應用程式。
  2. 在圖表上啟用「交易資料」圖層。
  3. 滑鼠移動到圖表上的交易標記上。
  4. **驗證**:
      - 是否彈出包含所有指定欄位的提示框？
      - `平倉損益淨額` 的顏色是否根據其正負值正確顯示（正為藍，負為紅）？
      - 資料內容是否正確？


# TradeCheck 交易審計系統規格書
- **版本**: v1.9
- **最後更新日期**: 2025-12-08

---

## 1. 專案概述 (Project Overview)
**TradeCheck** 是一個專為短線交易者設計的交易紀錄分析與風險控管工具。它能讀取用户的交易歷史（支援 `.csv` 或 `.xlsx` 格式），並根據 **D-Pro** 風控規則進行審計與 **交易 DNA 診斷**，最終生成一份綜合報告，幫助使用者評估其交易表現並識別潛在風險。

---

## 2. 核心功能 (Core Features)
(Sections 2.1 to 2.4 remain unchanged)
...

### 2.5 前端呈現 (Frontend Presentation)
- **月初本金顯示**: 在網頁介面的「帳戶狀態」區塊，新增顯示 `config.ini` 中設定的 `monthly_start_capital` (月初本金)。
- **年度總結區塊**: 在「月度總結」下方新增「年度總結」區塊，顯示審計期間各年份的總體交易表現，包括總損益、整體勝率、賺賠比和總交易筆數。
- **手動觸發分析**: 網頁介面的分析流程改為手動觸發。使用者需在選擇檔案後，點擊「開始分析」按鈕以啟動審計。

### 2.6 交易備註功能 (Trade Annotation Feature)
為了讓使用者能記錄每筆交易的決策背景或心得，系統新增了交易備註功能。

- **資料儲存**:
  - **儲存方式**: 使用者為交易所新增的備註將會儲存在本地端的 `trade_notes.db` (SQLite) 檔案中，不會修改原始的交易紀錄檔案。
  - **唯一識別**: 系統會為每一筆交易（基於成交時間、商品、損益等資訊）生成一個唯一的 `trade_id`，用於將備註與交易進行關聯。

- **前端互動**:
  - **檢視備註**: 在網頁介面的「月度詳細資料」彈窗中，新增「備註」欄位，顯示已儲存的備註。
  - **編輯備註**:
    - 在每一筆交易明細旁，提供一個「編輯」按鈕。
    - 點擊按鈕後，會彈出一個獨立的編輯視窗，使用者可在其中輸入或修改備註文字。
    - 儲存後，備註會寫入本地資料庫，並即時更新在明細表格中。

- **後端 API**:
  - `POST /api/trade_note`: 用於儲存或更新單筆交易的備註。
  - `POST /api/trade_notes`: 用於一次性獲取多筆交易的備註，以優化前端載入速度。

---

## 3. 指令碼模式 (Script Mode)
... (The rest of the document remains unchanged) ...

---

## 3. 指令碼模式 (Script Mode)

### 3.1 執行方式
使用者可透過執行 `trade_check.py` 指令碼來啟動分析。

- **指令**: `python trade_check.py`
- **配置文件**: 腳本會讀取 `config.ini` 以獲取 `月初本金` 及 `操作規模` 等參數。`目前權益數` 會根據 `月初本金` 和當月損益動態計算。
- **交易資料**: 腳本會自動讀取 `tradedata/` 目錄下的交易紀錄檔案。

### 3.2 輸出結果
執行完成後，會在根目錄生成一份 `audit_report.json`，包含完整的分析指標與審計結果。報告的 JSON 結構將擴充，以包含所有新增的分析結果，例如：
- `trading_dna_diagnosis`:
  - `noise_zone_verdict`: "陷入泥淖" 或 "防守得宜" 等文字評價。
  - `trend_zone_verdict`: "獲利核心" 或 "錯失行情" 等文字評價。
  - `monthly_point_target_progress`: 點數進度。
- `sop_risk_stress_test`:
  - `risk_ratio`: 風險率百分比。
  - `warning`: "高風險警告" 或空值。
- `risk_audit`:
  - `night_session_violation`: 布林值，表示是否違反夜盤避險規則。
- `capital_assessment`:
  - `quarterly_cost_deducted`: 實際扣除的固定成本金額。

---

## 4. 伺服器模式 (Server Mode)
... (伺服器模式章節維持不變) ...

---

## 7. 資料格式要求 (Data Format Requirements)

### 7.1 交易紀錄檔案 (Transaction Record File)
為了讓指令碼模式能順利執行，交易紀錄檔案（支援 `.csv` 或 `.xlsx`）需放置在 `tradedata/` 目錄下，且必須包含以下 **五個欄位**:

1.  **成交時間**: 交易發生的完整時間，格式需為 `YYYY/MM/DD HH:MM:SS`。
2.  **買賣別**: 交易的類型。
3.  **平倉損益淨額**: 該筆交易的淨損益，需為數值格式。
4.  **口數**: 交易的合約數量，需為數值格式。
5.  **商品名稱**: 用於判斷合約類型（e.g., `小型期`, `微型台指期`）。

**注意**: 腳本會自動將這些中文欄位名稱映射到內部處理所用的英文名稱。

---

## 8. 運維特性 (Operational Features)
... (運維特性章節維持不變) ...
---

## 附錄：帳戶升級資格計算方法

本系統會根據以下規則，評估帳戶是否符合升級資格。所有規則皆定義於 `trade_check.py`。

### 1. 升級標準 (Upgrade Criteria)
... (此表格維持不變) ...

### 2. 關鍵績效指標 (KPI) 計算方式
... (此章節維持不變) ...

### 3. 資格綜合評估
在 `_evaluate_capital_management` 函式中，系統會將您目前的 **資本額** 與計算出的 **KPI 指標** 與 `UPGRADE_CRITERIA` 中的標準進行比對。

一筆帳戶必須 **同時滿足** 以下兩個條件，才能獲得升級資格：

1.  **資本額達標 (Capital OK)**:
    -   `您目前的資本額 (經季末成本調整後) >= 該級別的資本額要求`

2.  **交易表現達標 (Performance OK)**:
    -   `您的風報比 >= 該級別的風報比要求`
    -   **且** `您的勝率 >= 該級別的勝率要求`

如果其中任何一項不滿足，系統將判定為不符合升級資格，並在報告中明確指出未達標的項目。

### 4. 新增：特殊計算規則說明

- **交易點數 (Points) 計算**:
  - 為了進行 DNA 診斷，系統會將每筆交易的 `平倉損益淨額` 轉換為「點數」。
  - **公式**: `點數 = 平倉損益淨額 / (口數 * 點值)`
  - **點值**: 根據交易紀錄中的 `商品名稱` 決定。
    - `小型期` (Mini-Taiex): 50 TWD/點
    - `微型台指期` (Micro-Taiex): 10 TWD/點
    - `大台` (Taiex): 200 TWD/點 (若適用)

- **固定成本扣除 (中哥費 / Brother Chung Cost)**:
  - **目的**: 模擬真實世界中的固定營運成本 (e.g., 軟體、資訊源費用)。
  - **觸發時機**: 當升級審查的月份為 **3月、6月、9月、或12月** 時觸發。
  - **計算方式**: `調整後資本額 = 目前權益數 - 25,000`。
  - **應用**: 此`調整後資本額`專門用於升級資格的「資本額達標」判斷。系統報告需明確列出「固定成本扣除」項目，確保使用者了解淨值調整細節。

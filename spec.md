# TradeCheck K線圖與資料管理功能規格書

- **版本**: v2.6
- **最後更新日期**: 2025-12-12

## 1. 總覽

本文件旨在詳細說明 `TradeCheck` 應用程式中 K 線圖（Candlestick Chart）與核心資料管理功能的行為與規格，重點涵蓋資料處理、圖表互動、以及各項分析工具的技術實現。

---

## 2. 資料匯入與管理 (Data Import and Management)

### 2.1 交易資料匯入 (`tradedata`)
- **UI**: 主畫面左側面板提供檔案選擇器與「匯入此檔案」按鈕。
- **後端 API**: `POST /api/import_trades`
- **處理流程**:
    1. 前端傳送使用者選擇的 `filename`。
    2. 後端讀取 `tradedata/` 目錄下的對應 CSV 檔案。
    3. **系統會處理 CSV 中所有欄位**，特別是以下核心欄位：
        - `成交時間`
        - `買賣別`
        - `商品名稱`
        - `口數`
        - `新倉價`
        - `平倉價`
        - `手續費`
        - `期交稅`
        - `平倉損益淨額`
    4. 後端將這些資料寫入 `trades` 資料庫表格中。`trade_id` 作為主鍵，使用 `INSERT OR IGNORE` 策略防止重複匯入。
    5. 前端透過 `alert` 顯示匯入結果，包含新增及因重複而跳過的筆數。

### 2.2 K 線資料匯入 (`KData`)
- **UI**: 主畫面左側面板提供「匯入 K 棒資料」按鈕，點擊後彈出檔案選擇視窗。
- **後端 API**: `POST /api/import-kdata`
- **處理流程**:
    1. 前端先透過 `GET /api/kdata-files` 獲取可匯入的檔案列表。
    2. 使用者選擇檔案並確認後，前端將 `filename` 傳送至後端。
    3. 後端讀取 `KData/` 目錄下的對應 CSV 檔案，並寫入 `market_data` 資料庫表格。`Datetime` 欄位作為主鍵，防止重複匯入。

### 2.3 清空交易資料 (Clear Trade Data)
- **UI**: 在主畫面的左側控制面板中，提供一個紅色的「清空交易資料」按鈕，以警示其為破壞性操作。
- **行為**:
    1.  點擊按鈕後，系統會彈出一個 `window.confirm` 確認對話框，警告使用者此操作將永久刪除所有交易資料且無法復原。
    2.  使用者確認後，前端向 `/api/clear_trades` 端點發送 `POST` 請求。
    3.  操作成功後，前端會 `alert` 成功訊息，並自動**重新整理頁面** (`window.location.reload()`) 以確保所有相關視圖（圖表、報告）都反映出資料已被清空的狀態。
- **後端 API 規格**:
    - **端點**: `POST /api/clear_trades`
    - **描述**: 刪除 `trades` 資料表中的所有紀錄。
    - **成功回應 (200 OK)**:
      ```json
      {
        "status": "success",
        "message": "Successfully cleared trades table. X rows were deleted.",
        "deleted_rows": X
      }
      ```

---

## 3. K 線圖核心需求

### 3.1 資料載入與適配
*   **初次載入**: 當使用者首次開啟「行情圖表」分頁時，系統應自動向後端請求預設時間週期（1分鐘）的 K 線資料。載入完成後，圖表應自動調整其時間軸與價格軸，以將所有歷史資料完整地顯示在圖表容器的寬度內。
*   **響應式縮放**: 當瀏覽器視窗或圖表容器的大小改變時，圖表必須能自動調整其尺寸，並重新縮放以適配所有資料。

### 3.2 時間軸 (X軸) 功能
圖表提供基於按鈕和滑鼠的直觀操作，以進行時間軸的縮放與平移。

#### 3.2.1 按鈕控制
*   **放大/縮小按鈕**: 使用者可透過點擊按鈕，以當前可見範圍的中心點為基準進行縮放。
*   **重置縮放按鈕**: 點擊「重置縮放」按鈕，圖表將立即恢復到其初始狀態，將所有資料完整顯示於容器內。

#### 3.2.2 滑鼠互動 (直覺控制)
*   **滾輪縮放**: 使用者可透過滑鼠滾輪進行縮放，縮放中心點為滑鼠游標所在的位置。
*   **拖曳平移**: 使用者可透過點擊並拖曳圖表來水平捲動時間軸。

### 3.3 價格軸 (Y軸) 管理
Y 軸的縮放管理確保了價格資訊的清晰可見，並提供手動控制選項。

*   **自動縮放 (Auto-scaling)**:
    *   Y 軸會自動調整其可見範圍，以緊密貼合當前時間範圍內 K 線與可見指標線的最高價與最低價。此功能透過自訂的 `autoscaleInfoProvider` 實現，確保所有圖層均可見。
*   **手動範圍設定**:
    *   使用者可透過工具列手動指定 Y 軸的顯示範圍。
*   **重置手動範圍**:
    *   點擊「重設Y軸範圍」按鈕，將清除手動設定，使 Y 軸恢復為自動縮放模式。

---

## 4. 功能工具列規格

圖表上方提供一個功能工具列，整合了多項分析與操作功能。

### 4.1 時間週期切換 (Timeframe Selection)
- **UI**: 一個下拉式選單。
- **選項**: 1分鐘 (1T), 5分鐘 (5T), 15分鐘 (15T), 1小時 (1H), 日線 (1D)。
- **行為**: 選擇新的時間週期後，前端會向後端 `/api/kline_data` 端點發出帶有 `timeframe` 參數的新請求。後端收到後，會利用 Pandas 的 `resample()` 功能將原始資料聚合成目標週期，並回傳給前端進行圖表刷新。

### 4.2 技術指標圖層 (Technical Indicators)
- **UI**: 一組核取方塊 (Checkbox)。
- **已實作選項**:
    - **移動平均線 (MA)**: 提供 MA5, MA10, MA20, MA60 四個週期的開關。
    - **布林通道 (Bollinger Bands)**: 提供一個開關，顯示上、中、下三條軌道線 (20週期, 2個標準差)。
- **行為**: 指標計算完全在前端 (`KlineChart.vue`) 進行。當使用者勾選某個指標時，前端會根據當前的 K 線資料即時計算指標數據，並使用 `addLineSeries` 將其繪製到圖表上。

### 4.3 交易資料顯示 (Trade Data Display)
- **UI**:
    - 一個「交易資料」核取方塊，用於在 K 線圖上顯示交易標記。
- **圖層標記行為**:
    - 當「交易資料」核取方塊被勾選時，前端會向後端 `/api/trade_data` 請求交易紀錄。
    - 前端使用 `setMarkers()` API，將買點（綠色向上箭頭）和賣點（紅色向下箭頭）繪製在對應的 K 棒上。
    - 滑鼠懸停在標記上時，會顯示一個包含交易時間、口數、新倉/平倉價、損益等詳細資訊的提示框。

### 4.4 圖表類型切換 (Chart Type)
- **UI**: 一組按鈕（例如「K線圖」、「線圖」）。
- **行為**: 點擊按鈕後，前端會移除當前的 K 線或線圖序列，並使用相同的資料重新建立一個新類型的序列。

### 4.5 匯出圖表 (Export Chart)
- **UI**: 一個「匯出圖表」按鈕。
- **行為**: 利用 `lightweight-charts` 的 `takeScreenshot()` API 獲取當前圖表畫面的圖片，並觸發瀏覽器下載為 `.png` 檔案。

---

## 5. 後端核心 API 規格 (Backend Core API Specifications)

本節詳細定義主要後端 API 的請求與回應格式。

### 5.1 GET /api/kline_data
- **目的**: 獲取 K 線資料以供前端圖表繪製。
- **方法**: `GET`
- **查詢參數**:
    - `timeframe` (string, optional): 時間週期，可選值為 `1T`, `5T`, `15T`, `1H`, `1D`。預設為 `1T`。
- **成功回應 (200 OK)**:
    - **內容**: 一個 JSON 陣列，其中每個物件代表一根 K 棒。
    - **物件欄位**:
        - `time` (integer): K 棒起始時間的 UNIX 時間戳 (秒)。
        - `open` (number): 開盤價。
        - `high` (number): 最高價。
        - `low` (number): 最低價。
        - `close` (number): 收盤價。
        - `value` (number): 該週期的總成交量。

### 5.2 GET /api/trade_data
- **目的**: 獲取指定時間範圍內的所有交易紀錄，以供前端圖表標記與表格使用。
- **方法**: `GET`
- **查詢參數**:
    - `start_time` (integer, required): 查詢起始時間的 UNIX 時間戳 (秒)。
    - `end_time` (integer, required): 查詢結束時間的 UNIX 時間戳 (秒)。
- **成功回應 (200 OK)**:
    - **內容**: 一個 JSON 陣列，其中每個物件代表一筆交易紀錄。
    - **物件欄位**:

| 欄位           | 型別    | 說明                                                                 |
| -------------- | ------- | -------------------------------------------------------------------- |
| `trade_id`     | String  | 該筆交易的唯一識別碼 (SHA256雜湊)。                                |
| `trade_time`   | String  | 交易時間，格式為 `YYYY-MM-DD HH:MM:SS` 的字串。                 |
| `action`       | String  | 買賣別，例如 "Buy" 或 "Sell"。                                    |
| `net_pnl`      | Number  | 該筆交易的平倉損益淨額。                                           |
| `contracts`    | Integer | 口數。                                                               |
| `product_name` | String  | 商品名稱。                                                           |
| `source_file`  | String  | 該筆紀錄來源的 CSV 檔名。                                          |
| `open_price`   | Number  | 新倉價。                                                             |
| `close_price`  | Number  | 平倉價。                                                             |
| `fee`          | Number  | 手續費。                                                             |
| `tax`          | Number  | 期交稅。                                                             |
| `time`         | Integer | 與 `trade_time` 相同的 UNIX 時間戳 (秒)，供圖表庫使用。          |
| `marker_price` | Number  | 用於在圖表上標記的價格，通常為收盤價。                               |
# TradeCheck 交易審計系統規格書

---

## 1. 專案概述 (Project Overview)
**TradeCheck** 是一個專為短線交易者設計的交易紀錄分析與風險控管工具。它能讀取用户的交易歷史（支援 `.csv` 或 `.xlsx` 格式），並根據預設的風控規則進行審計，最終生成一份綜合報告，幫助使用者評估其交易表現並識別潛在風險。

---

## 2. 核心功能 (Core Features)

### 2.1 交易紀錄分析 (Transaction Analysis)
- **支援格式**: 可讀取並解析 `.csv` 及 `.xlsx` 格式的交易紀錄檔案。
- **資料提取**: 自動從交易紀錄中提取關鍵資訊，包括 `成交時間`、`買賣別` 及 `平倉損益淨額`。
- **指標計算**:
  - **勝率 (Win Rate)**: 計算 `(獲利交易筆數 / 總交易筆數) * 100%`。
  - **賺賠比 (Profit/Loss Ratio)**: 計算 `平均每筆獲利金額 / 平均每筆虧損金額`。
  - **月損益 (Monthly PnL)**: 計算指定月份內所有交易的總損益。

### 2.2 風險審計 (Risk Audit)
系統會根據以下規則進行自動審計：
1.  **最大連續虧損筆數 (Max Consecutive Losses)**:
    - **規則**: 連續虧損不得超過 **5** 筆。
    - **觸發**: 當偵測到連續虧損達到或超過此上限時，系統會發出警示。
2.  **單日最大虧損金額 (Max Daily Loss)**:
    - **規則**: 當日總虧損不得超過 `目前權益數 * 2%`。
    - **觸發**: 當日累積虧損超過此上限時，系統會發出警示。

### 2.3 帳戶升級評估 (Account Upgrade Assessment)
系統會根據以下條件，評估使用者是否具備晉升至下一級操作規模的資格：
- **評估週期**: 每月進行一次。
- **評估標準**:
  1. **連續三個月皆為正損益**: 最近三個月的 `月損益` 均 > 0。
  2. **風險事件未觸發**: 在此三個月期間，從未觸發 `最大連續虧損` 或 `單日最大虧損` 警示。
- **結果**:
  - **成功**: 帳戶可`升級`至新的操作規模。
  - **失敗**: 維持目前規模，並提供未達標原因。

---

## 3. 指令碼模式 (Script Mode)

### 3.1 執行方式
使用者可透過執行 `trade_check.py` 指令碼來啟動分析。

- **指令**: `python trade_check.py`
- **配置文件**: 腳本會讀取 `config.ini` 以獲取 `目前權益數`、`月初本金` 及 `操作規模` 等參數。
- **交易資料**: 腳本會自動讀取 `tradedata/` 目錄下的交易紀錄檔案。

### 3.2 輸出結果
執行完成後，會在根目錄生成一份 `audit_report.json`，包含完整的分析指標與審計結果。

---

## 4. 伺服器模式 (Server Mode)

### 4.1 啟動方式
執行 `server.py` 可啟動一個本地 Web 伺服器。

- **指令**: `python server.py`

### 4.2 API 端點 (API Endpoints)
-   **`GET /api/upgrade-criteria`**:
    -   **功能**: 提供官方的各級別帳戶升級標準。
    -   **回傳**: 回傳一個以級別名稱為鍵的 JSON 物件，包含 `next_scale`, `capital_key`, `rr_key`, `wr_key`。
-   **`POST /api/audit`**:
    -   **功能**: 接收使用者上傳的交易紀錄檔案及表單參數，執行核心審計邏輯。
    -   **回傳**:
        -   成功時，回傳包含完整審計結果的 JSON 報告。此報告擴充了指令碼模式的輸出，額外包含 `monthly_trades` 欄位，該欄位以月為鍵，值為該月所有交易的詳細列表，供前端進行互動式展示。
        -   失敗時，回傳 4xx 或 5xx 狀態碼及錯誤訊息。
-   **`POST /api/log`**:
    -   **功能**: 接收由前端回傳的 JSON 格式日誌訊息，並使用後端的 Logger 將其記錄到 `trade_audit.log` 檔案和主控台。
-   **`GET /api/status`**:
    -   **功能**: 提供一個簡單的健康檢查端點。前端可透過此端點偵測後端伺服器是否正在運行。
    -   **回傳**: 回傳 `{"status": "ok", "message": "TradeCheck backend is running"}`。

---

## 5. 設定檔 (`config.ini`)
本系統透過 `config.ini` 進行參數配置，其結構如下：

```ini
[settings]
equity = 100000
initial_capital = 100000
scale = 500000
```

- **equity**: 目前權益數
- **initial_capital**: 月初本金
- **scale**: 目前操作規模

---

## 6. 視覺化前端介面 (Visualization Frontend)
為提升使用者體驗，本系統額外建置了網頁前端介面，將後端產出的 JSON 審計報告進行視覺化呈現。

### 6.1 介面概述 (UI Overview)
前端介面採用儀表板 (Dashboard) 風格設計，主要分為三大區塊：
1.  **頂部標頭區**:
    -   **後端狀態顯示**: 包含一個狀態指示燈，即時顯示與後端伺服器的連線狀態（連線中/已斷線）。
    -   **語言切換器**: 讓使用者可以即時切換介面語言。
2.  **左側輸入區**:
    -   **系統參數表單**: 讓使用者以圖形化方式輸入`目前權益數`、`月初本金`及`操作規模`。
    -   **檔案上傳**: 提供按鈕讓使用者上傳交易紀錄檔案（支援 `.csv`, `.xlsx`）。
3.  **右側報告區**:
    -   **官方升級標準**: 儀表板啟動時會自動載入並顯示一個包含所有級別升級標準的完整表格，方便使用者隨時查閱。
    -   **KPI 卡片**: 以醒目的卡片格式即時呈現`勝率`、`賺賠比`及`月損益`等關鍵指標。
    -   **狀態面板**: 透過清晰的區塊及顏色標示（綠色代表安全/通過，紅色代表警示/違規），顯示`帳戶狀態`、`風險檢查結果`與`升級評估`。
    -   **月度總覽表格**: 以表格形式呈現每月的匯總數據。

### 6.2 使用者互動 (User Interaction)
-   **後端狀態監控**: 前端介面會定期（每 10 秒）呼叫後端的 `/api/status` 端點，並更新頂部標頭的狀態指示燈，讓使用者清楚了解後端服務是否正常。
-   **互動式月報表**: 在報告區的「月度總覽」表格中，每一列都是可點擊的。點擊任一月份，系統會彈出一個互動視窗 (Modal)，其中包含該月份所有交易的詳細清單（成交時間、買賣別、淨損益），方便使用者進行深入分析。

### 6.3 多國語系支援 (Internationalization)
- **語言切換**: 介面右上角提供下拉式選單，支援即時切換**繁體中文 (zh-TW)**與**英文 (en)** 兩種語言。
- **翻譯範圍**: 介面上所有靜態標題、標籤與狀態文字皆会根據所選語言變更。由後端動態產生的文字訊息（如升級失敗原因）則會維持其原始語言。

---

## 7. 資料格式要求 (Data Format Requirements)

### 7.1 交易紀錄檔案 (Transaction Record File)
為了讓指令碼模式能順利執行，交易紀錄檔案（支援 `.csv` 或 `.xlsx`）需放置在 `tradedata/` 目錄下，且必須包含以下三個欄位：

1.  **成交時間**: 交易發生的完整時間，格式需為 `YYYY/MM/DD HH:MM:SS`。
2.  **買賣別**: 交易的類型。
3.  **平倉損益淨額**: 該筆交易的淨損益，需為數值格式（可包含千分位符號，如 `20,060`）。

**注意**: 腳本會自動將這些中文欄位名稱映射到內部處理所用的英文名稱 (`trade_time`, `action`, `net_pnl`)。

---

## 8. 運維特性 (Operational Features)

### 8.1 日誌紀錄 (Logging)
-   **目標**: 提供詳細、可供追蹤的系統執行紀錄，用於問題診斷、錯誤分析與行為監控。
-   **實作**:
    -   採用 Python 原生的 `logging` 模組進行設定。
    -   日誌記錄器在 `trade_check.py` 中進行集中配置，並在 `server.py` 中共用。
    -   前端應用透過 `fetch` API 呼叫後端的 `/api/log` 端點，將日誌訊息以 JSON 格式傳送至後端進行統一紀錄。
-   **輸出管道**:
    -   **檔案 (File)**: `INFO` 等級以上的日誌會寫入至專案根目錄的 `trade_audit.log` 檔案中。
    -   **主控台 (Console)**: `INFO` 等級以上的日誌也會同步輸出至標準輸出 (stdout)。
-   **日誌格式**: `時間戳 - 模組名稱 - 日誌等級 - 訊息內容` (e.g., `2025-12-04 15:30:00,123 - trade_check - INFO - Loading transactions from file...`)。
-   **紀錄範圍**: 涵蓋系統啟動、前端操作事件、API 請求接收、檔案上傳與處理、審計規則計算、錯誤與例外（包含完整的 Traceback）等關鍵事件。
---

## 附錄：帳戶升級資格計算方法

本系統會根據以下規則，評估帳戶是否符合升級資格。所有規則皆定義於 `trade_check.py`。

### 1. 升級標準 (Upgrade Criteria)

系統內建一個 `UPGRADE_CRITERIA` 字典，明確定義了從目前交易規模 (Scale) 晉升至下一級別所需的客觀條件。

**各級別升級標準如下：**

| 目前級別 | 目標級別 | 資本額要求 (Capital Key) | 風報比要求 (RR Key) | 勝率要求 (WR Key) |
|:--------:|:--------:|:--------------------------:|:-------------------:|:-----------------:|
|    S1    |    S2    |        `>= 200,000`        |      `>= 1.5`       |      `>= 25%`     |
|    S2    |    S3    |        `>= 400,000`        |      `>= 2.0`       |      `>= 30%`     |
|    S3    |    S4    |        `>= 600,000`        |      `>= 2.0`       |      `>= 33%`     |
|    S4    |    S5    |        `>= 800,000`        |      `>= 2.5`       |      `>= 35%`     |

### 2. 關鍵績效指標 (KPI) 計算方式

系統會透過 `_calculate_kpis` 函式，基於您的交易紀錄來計算以下兩個核心指標：

-   **勝率 (Win Rate, WR)**
    -   **定義**: 獲利交易的筆數在所有交易總筆數中所佔的比例。
    -   **計算公式**:
        ```
        勝率 = (獲利交易總筆數 / 總交易筆數)
        ```

-   **風報比 (Risk/Reward Ratio, RR)**
    -   **定義**: 平均每筆獲利金額與平均每筆虧損金額之間的比率，用以衡量冒險的效益。
    -   **計算公式**:
        ```
        風報比 = 平均獲利金額 / ABS(平均虧損金額)
        ```
        *註：`ABS` 代表取絕對值。*

### 3. 資格綜合評估

在 `_evaluate_capital_management` 函式中，系統會將您目前的 **資本額** 與計算出的 **KPI 指標** 與 `UPGRADE_CRITERIA` 中的標準進行比對。

一筆帳戶必須 **同時滿足** 以下兩個條件，才能獲得升級資格：

1.  **資本額達標 (Capital OK)**:
    -   `您目前的資本額 >= 該級別的資本額要求`

2.  **交易表現達標 (Performance OK)**:
    -   `您的風報比 >= 該級別的風報比要求`
    -   **且** `您的勝率 >= 該級別的勝率要求`

如果其中任何一項不滿足，系統將判定為不符合升級資格，並在報告中明確指出未達標的項目。

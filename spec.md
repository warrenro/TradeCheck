# TradeCheck K線圖功能規格書

- **版本**: v2.4
- **最後更新日期**: 2025-12-09

## 1. 總覽

本文件旨在詳細說明 `TradeCheck` 應用程式中 K 線圖（Candlestick Chart）功能的行為與規格，重點涵蓋資料處理、圖表互動、以及各項分析工具的技術實現。此圖表功能主要基於 `lightweight-charts` 函式庫建構。

## 2. 核心需求

### 2.1 資料載入與適配
*   **初次載入**: 當使用者首次開啟「行情圖表」分頁時，系統應自動向後端請求預設時間週期（1分鐘）的 K 線資料。載入完成後，圖表應自動調整其時間軸與價格軸，以將所有歷史資料完整地顯示在圖表容器的寬度內。
*   **響應式縮放**: 當瀏覽器視窗或圖表容器的大小改變時，圖表必須能自動調整其尺寸，並重新縮放以適配所有資料。

### 2.2 時間軸 (X軸) 功能
圖表提供基於按鈕和滑鼠的直觀操作，以進行時間軸的縮放與平移。

#### 2.2.1 按鈕控制
*   **放大按鈕**: 點擊「放大」按鈕，使用者可以縮小可見的時間範圍，以檢視更細節的 K 線。
    *   每次點擊會將可見範圍縮小一個預設係數（例如 20%）。
    *   縮放應以當前可見範圍的中心點為基準。
    *   為防止過度放大，縮放設有最小可見 K 棒數量的下限（例如 5 根），避免圖表變得難以辨識。
*   **縮小按鈕**: 點擊「縮小」按鈕，使用者可以擴大可見的時間範圍，以瀏覽更長期的趨勢。
    *   每次點擊會將可見範圍擴大一個預設係數（例如 20%）。
    *   縮放同樣以當前可見範圍的中心點為基準。
    *   縮放範圍不會超過所有可用資料的總時間跨度。
*   **重置縮放按鈕**: 點擊「重置縮放」按鈕，圖表將立即恢復到其初始狀態，將所有資料完整顯示於容器內。

#### 2.2.2 滑鼠互動 (直覺控制)
*   **滾輪縮放**: 使用者可透過滑鼠滾輪進行縮放。
    *   向上滾動（遠離使用者）為放大；向下滾動（朝向使用者）為縮小。
    *   縮放中心點為滑鼠游標所在的位置。
*   **拖曳平移**: 使用者可透過點擊並拖曳圖表來水平捲動時間軸。
    - 向左拖曳可檢視更早的歷史資料。
    - 向右拖曳可檢視較新的資料。

### 2.3 價格軸 (Y軸) 管理
Y 軸的縮放管理確保了價格資訊的清晰可見，並提供手動控制選項。

*   **自動縮放 (Auto-scaling)**:
    *   在未啟用手動範圍設定時，Y 軸會自動調整其可見範圍，以緊密貼合當前時間範圍內資料的最高價與最低價。這確保了無論如何縮放或平移，價格的垂直顯示都是最佳化的。
*   **手動範圍設定**:
    *   使用者可透過工具列中的「Y軸最小值」和「Y軸最大值」輸入框，手動指定 Y 軸的顯示範圍。
    *   點擊「設定Y軸範圍」按鈕後，Y 軸將固定在指定的範圍內，自動縮放功能會暫時停用。
    *   系統會驗證輸入值是否為有效數字，且最大值必須大於最小值。
*   **重置手動範圍**:
    *   點擊「重設Y軸範圍」按鈕，將清除手動設定，使 Y 軸恢復為自動縮放模式。

### 2.4 K棒顯示優化
*   為確保 K 棒在任何縮放級別下都能清晰可見，而不是被壓縮成細線，`timeScale` 被設置了明確的 `barSpacing`（例如 `6`）。

---

## 3. 功能工具列規格

圖表上方提供一個功能工具列，整合了多項分析與操作功能。

### 3.1 時間週期切換 (Timeframe Selection)
- **UI**: 一個下拉式選單。
- **選項**: 1分鐘 (1T), 5分鐘 (5T), 15分鐘 (15T), 1小時 (1H), 日線 (1D)。
- **行為**: 選擇新的時間週期後，前端會向後端 `/api/kline_data` 端點發出帶有 `timeframe` 參數的新請求。後端收到後，會利用 Pandas 的 `resample()` 功能將原始資料聚合成目標週期，並回傳給前端進行圖表刷新。

### 3.2 技術指標圖層 (Technical Indicators)
- **UI**: 一組核取方塊 (Checkbox)。
- **已實作選項**:
    - **移動平均線 (MA)**: 提供 MA5, MA10, MA20, MA60 四個週期的開關。
    - **布林通道 (Bollinger Bands)**: 提供一個開關，顯示上、中、下三條軌道線 (20週期, 2個標準差)。
- **行為**: 指標計算完全在前端 (`KlineChart.vue`) 進行。當使用者勾選某個指標時，前端會根據當前的 K 線資料即時計算指標數據，並使用 `addLineSeries` 將其繪製到圖表上。

### 3.3 交易資料顯示 (Trade Data Display)
- **UI**:
    - 一個「交易資料」核取方塊，用於在 K 線圖上顯示交易標記。
    - 圖表下方應顯示一個交易資料表格。
- **圖層標記行為**:
    - 當「交易資料」核取方塊被勾選時，前端會向後端 `/api/trade_data` 請求交易紀錄。
    - 前端使用 `setMarkers()` API，將買點（綠色向上箭頭）和賣點（紅色向下箭頭）繪製在對應的 K 棒上。
- **表格顯示行為**:
    - 表格會顯示從後端獲取的詳細交易紀錄。
    - **顯示欄位**:
        1.  成交時間
        2.  口數
        3.  新倉價
        4.  平倉價
        5.  平倉損益淨額
    - **樣式**:
        - 「平倉損益淨額」欄位：
            - 若數值為正，文字顏色應為 **藍色**。
            - 若數值為負，文字顏色應為 **紅色**。

### 3.4 圖表類型切換 (Chart Type)
- **UI**: 一組按鈕（例如「K線圖」、「線圖」）。
- **選項**:
    - K 線圖 (Candlestick) - 預設
    - 線圖 (Line) - 基於收盤價
- **行為**: 點擊按鈕後，前端會移除當前的 K 線或線圖序列，並使用相同的資料重新建立一個新類型的序列。

### 3.5 匯出圖表 (Export Chart)
- **UI**: 一個「匯出圖表」按鈕。
- **行為**: 利用 `lightweight-charts` 的 `takeScreenshot()` API 獲取當前圖表畫面的圖片，並觸發瀏覽器下載為 `.png` 檔案。

---

## 4. 後端 API (`/api/kline_data`) 資料處理規格

### 4.1 資料來源
- 從 `trade_notes.db` 資料庫的 `market_data` 表中讀取所有 K 線資料。

### 4.2 時間週期處理 (Resampling)
- 當 API 收到 `timeframe` 參數時（非 `1T`），執行以下聚合邏輯：
  ```python
  df.resample(timeframe).agg({
      'open': 'first',
      'high': 'max',
      'low': 'min',
      'close': 'last',
      'volume': 'sum'
  })
  ```
- **空值處理 (關鍵修復)**:
  1.  **移除無效 K 棒**: 在聚合後，立即執行 `dropna(subset=['open', 'high', 'low', 'close'], how='all')`。此步驟會移除那些因原始資料不足而導致連 OHLC 都湊不齊的 K 棒（例如，一個時間區間內完全沒有交易），這是解決圖表消失問題的核心。
  2.  **替換剩餘 NaN**: 在最後回傳前，執行 `replace({np.nan: None})`，將剩餘的 `NaN` 值（例如 `volume` 在某些情況下可能為 `NaN`）替換為 JSON 相容的 `null`，避免序列化錯誤。

### 4.3 回傳格式
- 資料被格式化為符合 `lightweight-charts` 的 JSON 陣列，每個物件包含 `time` (Unix 時間戳), `open`, `high`, `low`, `close`, `value` (成交量)。

---

## 5. 前端圖表更新邏輯規格

### 5.1 元件 `KlineChart.vue`
- **狀態管理**: 透過 Vue 3 的 `ref` 來管理圖表實例、各個序列 (Series) 的引用、指標可見性等狀態。

### 5.2 圖表重建邏輯 (關鍵修復)
- **問題描述**: 當切換時間週期時，舊的圖表更新邏輯會錯誤地在一個全新的圖表實例上，嘗試移除一個屬於舊圖表實例的序列，導致 JavaScript 執行階段錯誤，中斷渲染。
- **修正後邏輯**:
  1. 在 `setupChart` 函式中，當需要重建圖表時 (例如切換圖表類型)，會先呼叫 `chart.remove()`。此方法會將圖表實例及其**所有**相關的子序列一併完整銷毀。
  2. 接著，將所有本地儲存的圖表及序列變數 (如 `chart`, `candlestickSeries`, `volumeSeries` 等) 手動設為 `null`。
  3. **移除所有多餘且錯誤的 `chart.removeSeries(...)` 呼叫**。
  4. 最後，才使用 `createChart()` 建立一個全新的、乾淨的圖表實例，並在上面新增序列。
- **結果**: 此修正確保了圖表在資料更新或類型切換時，能夠乾淨、無誤地銷毀與重建，徹底解決了圖表消失的問題。
---

## 交易資料顯示優化 (Trade Data Display Enhancement)

為了在K線圖上提供更豐富的交易資訊，將對交易圖層進行功能優化。

### 1. 後端 (server.py)

- **目標**:
  - 確認後端 API (`/api/trade_data`) 回傳的交易資料包含所有必要的欄位。
- **實作**:
  - 交易資料匯入流程 (`/api/import_trades`) 將進行修改，以處理包含 `新倉價 (open_price)` 和 `平倉價 (close_price)` 的CSV檔案。這些欄位將與 `成交時間 (trade_time)`, `口數 (contracts)`, 和 `平倉損益淨額 (net_pnl)` 一同存入 `trades` 資料庫。
  - `GET /api/trade_data` 函式將被修改，其 SQL 查詢及回傳的 JSON 物件會確保包含 `trade_time`, `contracts`, `open_price`, `close_price`, 以及 `net_pnl`。

### 2. 前端 (KlineChart.vue)

- **目標**:
  - 在 K 線圖上繪製交易標記，並在用戶滑鼠懸停時顯示包含詳細資訊的提示框 (Tooltip)。
- **實作**:
  - **修改 `drawTradeData` 函式**:
    - 將修改此函式，為每個交易標記附加一個自定義的提示框。
  - **設計提示框內容**:
    - 提示框將顯示一個列表或表格，包含：`成交時間`, `口數`, `新倉價`, `平倉價`, `平倉損益淨額`。
  - **實現條件性顏色**:
    - 在提示框的 `平倉損益淨額` 欄位上，將使用 Vue.js 的綁定語法來動態設定 CSS class。
    - 如果 `平倉損益淨額 > 0`，文字顏色設為藍色。
    - 如果 `平倉損益淨額 < 0`，文字顏色設為紅色。
  - **更新圖表**:
    - 確保在獲取新數據或切換可見性時，圖表能正確地重繪或清除這些交易標記及其提示框。

### 3. 測試與驗收

- **目標**:
  - 確保新功能如預期般運作。
- **步驟**:
  1. 啟動應用程式。
  2. 在圖表上啟用「交易資料」圖層。
  3. 滑鼠移動到圖表上的交易標記上。
  4. **驗證**:
      - 是否彈出包含所有指定欄位的提示框？
      - `平倉損益淨額` 的顏色是否根據其正負值正確顯示（正為藍，負為紅）？
      - 資料內容是否正確？
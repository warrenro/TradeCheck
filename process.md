# TradeCheck 開發與實作紀錄

本文檔記錄了 `TradeCheck` 專案根據 `spec.md` 進行功能開發與程式碼修改的完整流程。

---

## 1. 系統規格書 (System Specification)

以下為本次開發所依據的系統規格書 (`spec.md`) 全文。

# TradeCheck 交易審計系統規格書

---

## 1. 專案概述 (Project Overview)
**TradeCheck** 是一個專為短線交易者設計的交易紀錄分析與風險控管工具。它能讀取用户的交易歷史（支援 `.csv` 或 `.xlsx` 格式），並根據 **D-Pro** 風控規則進行審計與 **交易 DNA 診斷**，最終生成一份綜合報告，幫助使用者評估其交易表現並識別潛在風險。

---

## 2. 核心功能 (Core Features)

### 2.1 交易紀錄分析 (Transaction Analysis)
- **支援格式**: 可讀取並解析 `.csv` 及 `.xlsx` 格式的交易紀錄檔案。
- **資料提取**: 自動從交易紀錄中提取關鍵資訊，包括 `成交時間`、`買賣別`、`平倉損益淨額`、`口數`及`商品名稱`。
- **指標計算**:
  - **勝率 (Win Rate)**: 計算 `(獲利交易筆數 / 總交易筆數) * 100%`。
  - **賺賠比 (Profit/Loss Ratio)**: 計算 `平均每筆獲利金額 / 平均每筆虧損金額`。
  - **月損益 (Monthly PnL)**: 計算指定月份內所有交易的總損益。
  - **交易點數 (Points)**: `平倉損益淨額 / (口數 * 點值)`，用於交易DNA診斷。

#### 新增：交易 DNA 診斷 (Trading DNA Diagnosis)
系統需將每筆交易依「獲利/虧損點數」進行分類統計，以診斷交易行為。同時，系統需追蹤 `月目標點數 (Monthly Point Target): +30 點` 的達成進度。

- **噪音區 (Noise Zone / Loss DNA)**: `絕對點數 <= 40 點`。
  - **統計指標**: 計算此區間的 **交易筆數、勝率、總損益**。
  - **診斷邏輯**: 若此區間交易筆數佔總筆數 **超過 80%** 且 **總損益為負**，系統應標記為「**陷入泥淖 (Stuck in the Mud)**」，代表使用者可能陷入無效的過度交易。

- **波段區 (Trend Zone / Profit DNA)**: `絕對點數 > 40 點`。
  - **統計指標**: 計算此區間的 **交易筆數、勝率、總損益**。
  - **診斷邏輯**: 此區間被視為主要獲利來源。系統需監控其 **勝率是否維持在 30% 以上**。

- **綜合評價**: 系統將根據以上兩個區間的表現，提供一份包含數據與文字建議的綜合診斷報告。

### 2.2 風險審計 (Risk Audit)
系統會根據以下 **D-Pro** 規則進行自動審計：
1.  **日內風控 (Daily Stop)**:
    - **規則**: 單日虧損筆數不得超過 **3** 筆。
    - **觸發**: 當日累積虧損筆數 > 3，系統會標記為違規。
2.  **月度資金熔斷 (Capital Circuit Breaker)**:
    - **規則**: 當月總虧損不得超過 `月初本金 * 15%`。
    - **觸發**: 當月累積虧損超過此上限，系統會發出警示。
3.  **月度策略熔斷 (Strategy Circuit Breaker)**:
    - **規則**: 單月內觸發「日內風控」的次數不得超過 **10** 次。
    - **觸發**: 當月違規天數 > 10，系統會發出警示。
4.  **新增：夜盤避險時段 (Night Session Hedging Window)**:
    - **規則**: 於 `21:15-21:45` 及 `01:45-02:15` 兩個時段內，禁止開立新倉。
    - **觸發**: 若偵測到在此區間內的開倉交易，系統會標記為違規。

### 2.3 帳戶升級評估 (Account Upgrade Assessment)
系統會根據 **附錄** 中的 `UPGRADE_CRITERIA`，評估使用者是否具備晉升至下一級操作規模的資格。
- **評估週期**: 每月進行一次。
- **評估標準**:
  1. **資本額達標**: `調整後資本額 >= 目標級別要求`。
  2. **交易表現達標**: `風報比 (RR)` 與 `勝率 (WR)` 均達到目標級別要求。
- **特別計算規則**:
  1. **固定成本扣除 (中哥費)**:
     - **規則**: 於 **3, 6, 9, 12 月底**進行升級評估時，會從`目前權益數`中扣除 **25,000** 元作為季度固定成本。
     - **說明**: 此為模擬真實營運的固定支出。扣除後的資本額僅用於升級資格判斷，報告中會明確標示此扣除項。
  2. **幸福激勵 (Happiness Incentive)**:
     - 當月獲利且交易表現達標時，會提撥 **10%** 的獲利作為獎勵金。此金額**不會**影響升級評估的資本計算。

### 2.4 新增：SOP 風險壓力測試 (SOP Risk Stress Test)
根據 **D-Pro V2.99** 附錄，系統需計算當前操作規模下的潛在最大月度風險。
- **最大曝險點數**: 固定為 **1500 點** (模擬單月 60 筆交易，平均每筆停損 25 點)。
- **風險計算**:
  - **SOP-A (1口試單) 風險值**: `1500 * 點值 * 1口`。
  - **SOP-B (20%規模) 風險值**: `1500 * 點值 * (當前規模口數 * 0.2)`。
- **風險率 (Risk Ratio)**: `計算出的風險值 / 目前權益數`。
- **診斷**: 若 `風險率 > 15%`，系統應在報告中輸出「**高風險警告：建議降級或切換至 SOP-A**」。

---

## 3. 指令碼模式 (Script Mode)

### 3.1 執行方式
使用者可透過執行 `trade_check.py` 指令碼來啟動分析。

- **指令**: `python trade_check.py`
- **配置文件**: 腳本會讀取 `config.ini` 以獲取 `目前權益數`、`月初本金` 及 `操作規模` 等參數。
- **交易資料**: 腳本會自動讀取 `tradedata/` 目錄下的交易紀錄檔案。

### 3.2 輸出結果
執行完成後，會在根目錄生成一份 `audit_report.json`，包含完整的分析指標與審計結果。報告的 JSON 結構將擴充，以包含所有新增的分析結果，例如：
- `trading_dna_diagnosis`:
  - `noise_zone_verdict`: "陷入泥淖" 或 "防守得宜" 等文字評價。
  - `trend_zone_verdict`: "獲利核心" 或 "錯失行情" 等文字評價。
  - `monthly_point_target_progress`: 點數進度。
- `sop_risk_stress_test`:
  - `risk_ratio`: 風險率百分比。
  - `warning`: "高風險警告" 或空值。
- `risk_audit`:
  - `night_session_violation`: 布林值，表示是否違反夜盤避險規則。
- `capital_assessment`:
  - `quarterly_cost_deducted`: 實際扣除的固定成本金額。

---

## 4. 伺服器模式 (Server Mode)
... (伺服器模式章節維持不變) ...

---

## 7. 資料格式要求 (Data Format Requirements)

### 7.1 交易紀錄檔案 (Transaction Record File)
為了讓指令碼模式能順利執行，交易紀錄檔案（支援 `.csv` 或 `.xlsx`）需放置在 `tradedata/` 目錄下，且必須包含以下 **五個欄位**:

1.  **成交時間**: 交易發生的完整時間，格式需為 `YYYY/MM/DD HH:MM:SS`。
2.  **買賣別**: 交易的類型。
3.  **平倉損益淨額**: 該筆交易的淨損益，需為數值格式。
4.  **口數**: 交易的合約數量，需為數值格式。
5.  **商品名稱**: 用於判斷合約類型（e.g., `小型期`, `微型台指期`）。

**注意**: 腳本會自動將這些中文欄位名稱映射到內部處理所用的英文名稱。

---

## 8. 運維特性 (Operational Features)
... (運維特性章節維持不變) ...
---

## 附錄：帳戶升級資格計算方法

本系統會根據以下規則，評估帳戶是否符合升級資格。所有規則皆定義於 `trade_check.py`。

### 1. 升級標準 (Upgrade Criteria)
... (此表格維持不變) ...

### 2. 關鍵績效指標 (KPI) 計算方式
... (此章節維持不變) ...

### 3. 資格綜合評估
在 `_evaluate_capital_management` 函式中，系統會將您目前的 **資本額** 與計算出的 **KPI 指標** 與 `UPGRADE_CRITERIA` 中的標準進行比對。

一筆帳戶必須 **同時滿足** 以下兩個條件，才能獲得升級資格：

1.  **資本額達標 (Capital OK)**:
    -   `您目前的資本額 (經季末成本調整後) >= 該級別的資本額要求`

2.  **交易表現達標 (Performance OK)**:
    -   `您的風報比 >= 該級別的風報比要求`
    -   **且** `您的勝率 >= 該級別的勝率要求`

如果其中任何一項不滿足，系統將判定為不符合升級資格，並在報告中明確指出未達標的項目。

### 4. 新增：特殊計算規則說明

- **交易點數 (Points) 計算**:
  - 為了進行 DNA 診斷，系統會將每筆交易的 `平倉損益淨額` 轉換為「點數」。
  - **公式**: `點數 = 平倉損益淨額 / (口數 * 點值)`
  - **點值**: 根據交易紀錄中的 `商品名稱` 決定。
    - `小型期` (Mini-Taiex): 50 TWD/點
    - `微型台指期` (Micro-Taiex): 10 TWD/點
    - `大台` (Taiex): 200 TWD/點 (若適用)

- **固定成本扣除 (中哥費 / Brother Chung Cost)**:
  - **目的**: 模擬真實世界中的固定營運成本 (e.g., 軟體、資訊源費用)。
  - **觸發時機**: 當升級審查的月份為 **3月、6月、9月、或12月** 時觸發。
  - **計算方式**: `調整後資本額 = 目前權益數 - 25,000`。
  - **應用**: 此`調整後資本額`專門用於升級資格的「資本額達標」判斷。系統報告需明確列出「固定成本扣除」項目，確保使用者了解淨值調整細節。

---

## 2. 程式碼修改步驟 (Implementation Steps)

在收到新的規格書後，我遵循以下步驟來更新 `trade_check.py` 程式碼：

1.  **分析新規格**：詳細閱讀 `spec.md`，辨識出所有新增功能與修改項目，包括：
    *   交易 DNA 診斷
    *   SOP 風險壓力測試
    *   新的風險規則 (月度策略熔斷、夜盤開倉限制)
    *   帳戶升級評估調整 (季度成本)
    *   新的資料欄位要求 (`商品名稱`, `口數`)
    *   `config.ini` 的引入與 `audit_report.json` 的格式擴充

2.  **制定修改計畫**：根據分析結果，將整個開發任務拆解為以下可執行的子項目：

    1.  **更新程式設定與常數**:
        *   新增 `POINT_VALUE`, `TRADING_DNA_RULES`, `SOP_RISK_STRESS_TEST`, `QUARTERLY_COST` 等常數。

    2.  **修改 `load_transactions` (資料讀取函式)**:
        *   將 `口數` 和 `商品名稱` 加入必要欄位檢查與欄位映射。

    3.  **新增 `_add_trade_points_column` (計算交易點數)**:
        *   建立一個新的內部函式，用於計算每筆交易的「點數」，並在主資料表中新增 `points` 欄位。

    4.  **新增 `_run_trading_dna_diagnosis` (執行交易DNA診斷)**:
        *   建立新函式，根據交易的 `points` 進行「噪音區」與「波段區」的分析，並實作「陷入泥淖」的判斷邏輯。

    5.  **新增 `_run_sop_risk_stress_test` (執行SOP風險壓力測試)**:
        *   建立新函式，計算潛在風險值與風險率，並在超過閾值時發出警告。
        *   同時修改 `__init__` 建構函式以接收 `operation_contracts` 參數。

    6.  **修改 `_check_safety_valves` (風險審計檢查)**:
        *   新增「月度策略熔斷」邏輯，計算單月觸發「日內風控」的天數。

    7.  **修改 `_check_night_session` (夜盤交易檢查)**:
        *   將檢查邏輯聚焦於 `買賣別` 為「買進」或「賣出」的開倉交易。

    8.  **修改 `_evaluate_capital_management` (帳戶升級評估)**:
        *   加入「季度固定成本」的扣除邏輯。

    9.  **更新 `run_audit` (主審計流程)**:
        *   將所有新增的函式整合進主流程，並擴充最終輸出的 `audit_report.json` 報告結構。

    10. **引入 `config.ini` 設定檔**:
        *   建立 `config.ini` 檔案來管理使用者參數。
        *   修改主程式區塊，使其從設定檔讀取參數，並將最終報告寫入 `audit_report.json`。

3.  **逐項實作與修改**：按照上述計畫，逐一完成每個子項目的程式碼撰寫與修改。每個步驟都確保與 `spec.md` 的要求一致。

4.  **完成與交付**：所有步驟完成後，`trade_check.py` 已完全符合新規格書的要求。程式現在能夠讀取 `config.ini`，執行所有新的分析與審計，並生成一個結構完整、內容豐富的 `audit_report.json` 報告。
